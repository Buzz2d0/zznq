<!doctype html><html lang=zh-cn><head><meta charset=utf-8><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><meta name=viewport content="width=device-width,initial-scale=1"><title>golang web audit 小记 - zznQ</title><meta name=author content="zznq"><meta property="og:title" content="golang web audit 小记"><meta property="og:description" content="简单记录下Golang web代码审计。"><meta property="og:type" content="article"><meta property="og:url" content="https://zznq.imipy.com/posts/golang-web-audit/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-25T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="golang web audit 小记"><meta name=twitter:description content="简单记录下Golang web代码审计。"><link rel=stylesheet href=/style.min.5297c96c59a52afaa5bcda4a6cedf3813081f64025c209b25b2ee6d0c8f74d462b625ad3404a92a14d7a51b4ec0a420337ae70f426fa4bce2d5f7459a3ca7274.css integrity="sha512-UpfJbFmlKvqlvNpKbO3zgTCB9kAlwgmyWy7m0Mj3TUYrYlrTQEqSoU16UbTsCkIDN65w9Cb6S84tX3RZo8pydA=="><script>localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.setAttribute("data-theme","light")</script><script defer src=/js/header.7a2a109ec3782c57bad0332b662f8a5f41765505936b69868eb8bd5241de9daf23c388e82ca1831f6d09935013dcb9f71bfa7face3975880c1076028b7b0a6e1.js integrity="sha512-eioQnsN4LFe60DMrZi+KX0F2VQWTa2mGjri9UkHena8jw4joLKGDH20Jk1AT3Ln3G/p/rOOXWIDBB2Aot7Cm4Q=="></script>
<script defer src=/js/builtin-copy.56e07a74dd440b068ab36af35542ed8960865686c19fb809f38436877ac081570612cc8a913650b0c0e3073a336680c5df960e73bf7b1de83dc6aa996f2db858.js integrity="sha512-VuB6dN1ECwaKs2rzVULtiWCGVobBn7gJ84Q2h3rAgVcGEsyKkTZQsMDjBzozZoDF35YOc797Heg9xqqZby24WA=="></script>
<script defer src=/js/search-zh-cn.677e05c714f837051483647d736c45051126c22a2696ca5f981b59da962d48962f3ea71150f559ba84884fd1aadf1c7aadce55bb31a3e5b75c0f173b763c109a.js integrity="sha512-Z34FxxT4NwUUg2R9c2xFBREmwiomlspfmBtZ2pYtSJYvPqcRUPVZuoSIT9Gq3xx6rc5VuzGj5bdcDxc7djwQmg=="></script></head><body><main><header><div class=brand><div id=sidebar_btn><svg id="menu_icon" width="26" height="26" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></svg></div><div><a href=/>zznQ🎈</a></div></div><div class=toolbox><div id=theme_tool><svg id="dark_mode_btn" class="hidden toolbox-btn" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></svg><svg id="light_mode_btn" class="hidden toolbox-btn" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></svg></div><div id=search_tool><svg id="search_btn" class="toolbox-btn" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></svg><div id=search_menu_wrapper class=hidden><div id=search_menu><div id=search_menu_toolbar><div id=search_menu_input_wrapper><input id=search_menu_input type=text placeholder="Search Posts"></div><div id=search_menu_close_btn><svg width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></svg></div></div><div id=search_menu_results></div></div></div></div></div></header><nav id=navbar class=pure-menu><ul class=pure-menu-list><li class="navbar-item pure-menu-item insection"><a href=/posts/ class=pure-menu-link>文章</a></li><li class="navbar-item pure-menu-item"><a href=/categories/ class=pure-menu-link>分类</a></li><li class="navbar-item pure-menu-item"><a href=/tags/ class=pure-menu-link>标签</a></li></ul></nav><div id=sidebar_canvas_overlay class=hidden></div><div id=sidebar class=close><ul><li><a href=/posts/>文章</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li></ul></div><div id=content class=content-margin><details class=collapsible-menu-wrapper><summary class=collapsible-menu-type><span>Table of contents</span></summary><div class=collapsible-menu><nav id=TableOfContents><ul><li><a href=#sqli>SQLI</a><ul><li><a href=#mysql>MySQL</a></li></ul></li><li><a href=#xss>XSS</a></li><li><a href=#csrf>CSRF</a></li><li><a href=#目录遍历>目录遍历</a><ul><li><a href=#gin>gin</a></li></ul></li><li><a href=#命令执行>命令执行</a></li><li><a href=#代码执行>代码执行</a></li><li><a href=#jsonp劫持>Jsonp劫持</a><ul><li><a href=#如何自动化检测>如何自动化检测？</a></li></ul></li></ul></nav></div></details><div class=content-margin><article class=line-numbers><p>简单记录下Golang web代码审计。</p><h2 id=sqli>SQLI</h2><p><a href=https://golang.org/pkg/database/sql/>&ldquo;database/sql&rdquo;</a> 只是一个SQL数据库的通用接口，必须要与数据库驱动程序一起使用。</p><p>支持的数据库驱动列表：https://github.com/golang/go/wiki/SQLDrivers</p><h3 id=mysql>MySQL</h3><p>star 最多的 MySQL 驱动为<a href=https://github.com/go-sql-driver/mysql>github.com/go-sql-driver/mysql</a>，看下 <a href=https://github.com/go-sql-driver/mysql/blob/master/connection.go>connection.go</a> 文件中的两个主要函数：<code> Query(query string, args []driver.Value)</code> 和 <code>Exec(query string, args []driver.Value)</code>，如何过滤参数的。</p><p>通过判断 <code>len(args)</code> 长度，区分纯文本模式还是插值模式；插值模式时进入 <code>interpolateParams()</code> 函数过滤参数</p><p>遍历 <code>args</code> 通过类型断言分别进行参数处理，并在 <code>escapeBytesBackslash(buf, v []byte) []byte</code> 函数中又对每个字符进行检查</p><p>贴下代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75715e>// https://github.com/go-sql-driver/mysql/blob/b36cd86ebcb680d317f962679780f5877a0b91e1/connection.go#L198
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mysqlConn</span>) <span style=color:#a6e22e>interpolateParams</span>(<span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> []<span style=color:#a6e22e>driver</span>.<span style=color:#a6e22e>Value</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Number of ? should be same to len(args)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Count</span>(<span style=color:#a6e22e>query</span>, <span style=color:#e6db74>&#34;?&#34;</span>) <span style=color:#f92672>!=</span> len(<span style=color:#a6e22e>args</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>driver</span>.<span style=color:#a6e22e>ErrSkip</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mc</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>takeCompleteBuffer</span>()
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>query</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>arg</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>int64</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>AppendInt</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>uint64</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Handle uint64 explicitly because our custom ConvertValue emits unsigned values
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>AppendUint</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>float64</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>AppendFloat</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>, <span style=color:#e6db74>&#39;g&#39;</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>64</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>bool</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#39;0&#39;</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>IsZero</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#34;&#39;0000-00-00&#39;&#34;</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#39;\&#39;&#39;</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>appendDateTime</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>In</span>(<span style=color:#a6e22e>mc</span>.<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Loc</span>))
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#39;\&#39;&#39;</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>RawMessage</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#39;\&#39;&#39;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mc</span>.<span style=color:#a6e22e>status</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>statusNoBackslashEscapes</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>escapeBytesBackslash</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>escapeBytesQuotes</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#39;\&#39;&#39;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> []<span style=color:#66d9ef>byte</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#34;NULL&#34;</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#34;_binary&#39;&#34;</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mc</span>.<span style=color:#a6e22e>status</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>statusNoBackslashEscapes</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>escapeBytesBackslash</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>escapeBytesQuotes</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#39;\&#39;&#39;</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#39;\&#39;&#39;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mc</span>.<span style=color:#a6e22e>status</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>statusNoBackslashEscapes</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>escapeStringBackslash</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>escapeStringQuotes</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span> = append(<span style=color:#a6e22e>buf</span>, <span style=color:#e6db74>&#39;\&#39;&#39;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>driver</span>.<span style=color:#a6e22e>ErrSkip</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>buf</span>)<span style=color:#f92672>+</span><span style=color:#ae81ff>4</span> &gt; <span style=color:#a6e22e>mc</span>.<span style=color:#a6e22e>maxAllowedPacket</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>driver</span>.<span style=color:#a6e22e>ErrSkip</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> string(<span style=color:#a6e22e>buf</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// https://github.com/go-sql-driver/mysql/blob/b36cd86ebcb680d317f962679780f5877a0b91e1/utils.go#L692
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>escapeStringBackslash</span>(<span style=color:#a6e22e>buf</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>v</span> <span style=color:#66d9ef>string</span>) []<span style=color:#66d9ef>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pos</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>reserveBuffer</span>(<span style=color:#a6e22e>buf</span>, len(<span style=color:#a6e22e>v</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>v</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>c</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\x00&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span>] = <span style=color:#e6db74>&#39;\\&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] = <span style=color:#e6db74>&#39;0&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pos</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\n&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span>] = <span style=color:#e6db74>&#39;\\&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] = <span style=color:#e6db74>&#39;n&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pos</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\r&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span>] = <span style=color:#e6db74>&#39;\\&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] = <span style=color:#e6db74>&#39;r&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pos</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\x1a&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span>] = <span style=color:#e6db74>&#39;\\&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] = <span style=color:#e6db74>&#39;Z&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pos</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\&#39;&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span>] = <span style=color:#e6db74>&#39;\\&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] = <span style=color:#e6db74>&#39;\&#39;&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pos</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;&#34;&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span>] = <span style=color:#e6db74>&#39;\\&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] = <span style=color:#e6db74>&#39;&#34;&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pos</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\\&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span>] = <span style=color:#e6db74>&#39;\\&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>] = <span style=color:#e6db74>&#39;\\&#39;</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pos</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>buf</span>[<span style=color:#a6e22e>pos</span>] = <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pos</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>pos</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>所以使用 <code>插值模式</code> 规避大多数 SQL 注入，禁止使用传入的参数来拼接 SQL 语句。</p><p>如果你使用 <a href=https://github.com/go-gorm/gorm>gorm</a> 请注意 <a href=https://gorm.io/zh_CN/docs/security.html>https://gorm.io/zh_CN/docs/security.html</a> 列出的函数，使用插值模式或者检测过滤用户输入的参数。</p><h2 id=xss>XSS</h2><p>推荐阅读这片文章 <a href=https://tech.meituan.com/2018/09/27/fe-security.html>https://tech.meituan.com/2018/09/27/fe-security.html</a></p><p>从 golang 后端的角度来说，清楚知道数据最后落在前端位置并做好相对应转义规则。</p><h2 id=csrf>CSRF</h2><p>推荐阅读这片文章 <a href=https://tech.meituan.com/2018/10/11/fe-security-csrf.html>https://tech.meituan.com/2018/10/11/fe-security-csrf.html</a></p><h2 id=目录遍历>目录遍历</h2><h3 id=gin>gin</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Static</span>(<span style=color:#e6db74>&#34;/uploads&#34;</span>, <span style=color:#e6db74>&#34;./uploads&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;[Main] Gin engine error: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>探究下是否存在<strong>目录遍历</strong>，翻阅代码 static 最后处理的是路由 <code>/uploads/*filepath</code>，获取文件名 <code>file := c.Param("filepath")</code> 并打开获取文件内容 <code>f, err := fs.Open(file)</code></p><p>贴下代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>StaticFS</span>(<span style=color:#e6db74>&#34;/uploads&#34;</span>, <span style=color:#a6e22e>Dir</span>(<span style=color:#e6db74>&#34;./uploads&#34;</span>, <span style=color:#66d9ef>false</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>group</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RouterGroup</span>) <span style=color:#a6e22e>StaticFS</span>(<span style=color:#a6e22e>relativePath</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fs</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>FileSystem</span>) <span style=color:#a6e22e>IRoutes</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>handler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>group</span>.<span style=color:#a6e22e>createStaticHandler</span>(<span style=color:#a6e22e>relativePath</span>, <span style=color:#a6e22e>fs</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 路由规则
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>urlPattern</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>relativePath</span>, <span style=color:#e6db74>&#34;/*filepath&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>group</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#a6e22e>urlPattern</span>, <span style=color:#a6e22e>handler</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>group</span>.<span style=color:#a6e22e>HEAD</span>(<span style=color:#a6e22e>urlPattern</span>, <span style=color:#a6e22e>handler</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// createStaticHandler 生成静态文件处理路由
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>group</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RouterGroup</span>) <span style=color:#a6e22e>createStaticHandler</span>(<span style=color:#a6e22e>relativePath</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fs</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>FileSystem</span>) <span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>absolutePath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>group</span>.<span style=color:#a6e22e>calculateAbsolutePath</span>(<span style=color:#a6e22e>relativePath</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fileServer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StripPrefix</span>(<span style=color:#a6e22e>absolutePath</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>FileServer</span>(<span style=color:#a6e22e>fs</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Param</span>(<span style=color:#e6db74>&#34;filepath&#34;</span>)<span style=color:#75715e>// 获取文件名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// Check if file exists and/or if we have permission to access it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>file</span>) <span style=color:#75715e>// 打开文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fileServer</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Writer</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>http</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Dir</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#a6e22e>Dir</span>) <span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>File</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dir</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dir</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>dir</span> = <span style=color:#e6db74>&#34;.&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fullName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>FromSlash</span>(<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>Clean</span>(<span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>name</span>))) <span style=color:#75715e>// `Clean()` 方法看： https://golang.org/pkg/path/#Clean。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>fullName</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在看看最后如何打开文件的 <code>fullName := filepath.Join(dir, filepath.FromSlash(path.Clean("/"+name)))</code> 中的 <code>path.Clean("/"+name)</code> name 前的 <code>/</code> 字符很关键，让一切没有希望。。。</p><p><img src=https://user-images.githubusercontent.com/26270009/119491681-c9972c00-bd90-11eb-9753-9baaca83c4a5.png alt=image></p><p>想要实现静态文件时，最好使用 golang <code>http.Dir</code> 处理传入文件参数，避免目录遍历。</p><h2 id=命令执行>命令执行</h2><h2 id=代码执行>代码执行</h2><h2 id=jsonp劫持>Jsonp劫持</h2><p>Jsonp(JSON with Padding)是JSON的一种"使用模式"，可以让网页从别的域名（网站）那获取资料，即<strong>跨域读取数据</strong>。设计出来就是为了解决<a href=https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy>同源策略</a>的限制。</p><p>写个简单 jsonp demo：</p><p>server 代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/jsonp&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;bar&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;desc&#34;</span>: <span style=color:#e6db74>&#34;desc..&#34;</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSONP</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>client 代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span>&gt;
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>title</span>&gt;Jsonp Test&lt;/<span style=color:#f92672>title</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>data</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>alert</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>desc</span>);
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>	<span style=color:#75715e>&lt;!-- script --&gt;</span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://localhost:8080/jsonp?callback=log&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>	<span style=color:#75715e>&lt;!-- jquery --&gt;</span>
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$</span>(document).<span style=color:#a6e22e>ready</span>(<span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>$</span>.<span style=color:#a6e22e>ajax</span>({
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;get&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;http://localhost:8080/jsonp&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>dataType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;jsonp&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>jsonp</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;callback&#34;</span>,<span style=color:#75715e>//传递给请求处理程序或页面的，用以获得jsonp回调函数名的参数名(一般默认为:callback)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>jsonpCallback</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;log&#34;</span>,<span style=color:#75715e>//自定义的jsonp回调函数名称，默认为jQuery自动生成的随机函数名，也可以写&#34;?&#34;，jQuery会自动为你处理数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>success</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>data</span>) {},
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> () {<span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#39;fail&#39;</span>);}
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><h3 id=如何自动化检测>如何自动化检测？</h3><p><a href=https://koalr.me/post/a-tour-of-xray/>a-tour-of-xray</a>这篇博客中已经详细介绍了如何手工挖掘</p><p><img src=https://user-images.githubusercontent.com/26270009/121984526-b4c51b80-cdc5-11eb-8a58-377beaec845f.png alt=image></p><p>在“判断是否包含敏感信息”的部分也不是采取简单正则匹配发现敏感信息而是采用AST语义分析。我在此 <a href=https://github.com/jweny/check_jsonp_based_on_ast>jweny - check_jsonp_based_on_ast</a> 基础做了深度优化，真正的能检测类似如下js语句：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>callback</span>({<span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>:</span> {<span style=color:#a6e22e>username</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;jweny&#34;</span>}});
</span></span><span style=display:flex><span><span style=color:#a6e22e>callback</span>({<span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>:</span> {<span style=color:#a6e22e>a</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;jweny&#34;</span>,<span style=color:#a6e22e>test</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>:</span>[<span style=color:#e6db74>&#34;123&#34;</span>, <span style=color:#ae81ff>1</span>,{<span style=color:#a6e22e>username</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;xx&#34;</span>}]}});
</span></span><span style=display:flex><span><span style=color:#a6e22e>callback</span>([{<span style=color:#e6db74>&#34;info&#34;</span><span style=color:#f92672>:</span> {<span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;jweny&#34;</span>}}])
</span></span><span style=display:flex><span><span style=color:#a6e22e>cb</span>(<span style=color:#e6db74>&#39;  {&#34;username&#34;:&#34;jweny&#34;}  &#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>/*aa*/</span> window.<span style=color:#a6e22e>cb</span>({<span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;jweny&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#75715e>/*aa*/</span> window.<span style=color:#a6e22e>cb</span> <span style=color:#f92672>&amp;&amp;</span> window.<span style=color:#a6e22e>cb</span>({<span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;jweny&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#75715e>/*aa*/</span> <span style=color:#a6e22e>cb</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>cb</span>({<span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;jweny&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>a</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;jweny&#34;</span>}; <span style=color:#a6e22e>cb</span>({<span style=color:#e6db74>&#34;s&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>a</span>});
</span></span><span style=display:flex><span><span style=color:#a6e22e>a</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;jweny&#34;</span>}; <span style=color:#a6e22e>cb</span>(<span style=color:#a6e22e>a</span>);
</span></span></code></pre></div><p>相关源码贴在此：https://github.com/Buzz2d0/taser/blob/main/probe/jsonp.go</p></article><script src=https://utteranc.es/client.js repo=Buzz2d0/zznq issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer><article>Copyright © 2019-2022 by zznq</article></footer></main></body></html>